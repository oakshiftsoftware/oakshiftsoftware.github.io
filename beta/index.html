<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="https://oakshiftsoftware.github.io/source/images/logos/logo-b.png" type="image/png">
        <title>Oakshift Software</title>
        <style>
            /* Global Styles */
            :root {
                --font-family: 'Arial', sans-serif;
                --primary-color: #363636;
                --secondary-color: #18bc9c;
                --background-color: #d9d9d9;
                --text-color: #363636;
            }
            h1, h2, h3, h4, h5, h6, p {
                margin: 0;
            }
            body {
                font-family: var(--font-family);
                background-color: var(--background-color);
                color: var(--text-color);
                margin: 0;
                padding: 0;
            }
            header {
                background-color: var(--primary-color);
                color: white;
                padding: 2rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 50%;
            }
            .brand {
                display: flex;
                align-items: center;
            }
            .brand img {
                height: 75px;
                margin-right: 1rem;
            }
            .brand-text h1 {
                margin: 0;
                font-size: 1.5rem;
            }
            .brand-text p {
                margin: 0;
                font-size: 1rem;
            }
            nav ul {
                list-style: none;
                display: flex;
                margin: 0;
                padding: 0;
            }
            nav ul li {
                margin-left: 2rem;
            }
            nav ul li a {
                color: white;
                text-decoration: none;
                font-weight: bold;
            }
            nav ul li a:hover {
                text-decoration: underline;
            }
            main {
                padding: 0;
            }
            .main-content {
                padding: 2rem;
            }
            .hero-banner {
                width: -webkit-fill-available;
                height: 300px;
                overflow: hidden;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                text-align: center;
            }
            .hero-banner img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                position: absolute;
                z-index: 1;
            }
            .hero-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 2;
            }
            .hero-content {
                position: relative;
                z-index: 3;
                max-width: 800px;
                padding: 2rem;
            }
            .hero-content h1 {
                font-size: 2.5rem;
                margin-bottom: 1rem;
            }
            .hero-content p {
                font-size: 1.2rem;
                margin-bottom: 2rem;
            }
            .hero-button {
                display: inline-block;
                padding: 0.8rem 1.5rem;
                background: #646464;
                color: white;
                text-decoration: none;
                border-radius: 5px;
                font-weight: bold;
                transition: background-color 0.3s;
            }
            .hero-button:hover {
                background: #474747;
            }
            .card {
                background-color: #fafafa;
                padding: 2rem;
                margin-bottom: 2rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                border-radius: 2.5px;
            }
            .service-card {
                border-left: 4px solid var(--secondary-color);
            }
            .variant-list {
                list-style: none;
                padding: 0;
                margin: 1rem 0;
            }
            .service-header {
                /* Not clickable - header should not open modal */
                cursor: default;
                transition: background-color 0.15s ease;
                position: relative;
            }
            .service-header:hover {
                background-color: rgba(0,0,0,0.75);
            }
            .variant-item {
                display: flex;
                justify-content: space-between;
                padding: 0.75rem 0 0.75rem 0;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
                padding-right: 2.5rem;
            }
            .variant-item:last-child {
                border-bottom: none;
            }
            .variant-item::after {
                content: "‚ÑπÔ∏è";
                position: absolute;
                right: 0rem;
                top: 50%;
                transform: translateY(-50%);
                font-size: 1.2rem;
                opacity: 0.7;
                transition: opacity 0.2s;
            }
            .variant-item:hover {
                background-color: #f8f9fa;
            }
            .variant-item:hover::after {
                opacity: 1;
            }
            .category-tag {
                display: inline-block;
                padding: 0.25rem 0.5rem;
                margin: 0.25rem;
                background-color: var(--secondary-color);
                color: white;
                border-radius: 3px;
                font-size: 0.8rem;
            }
            .package-services {
                margin-top: 1rem;
                padding: 1rem;
                background-color: #f8f9fa;
                border-radius: 2.5px;
            }
            .service-group h4 {
                margin-bottom: 0.5rem;
                color: var(--primary-color);
            }
            .service-list {
                list-style: none;
                padding: 0;
            }
            .service-list li {
                padding: 0.25rem 0;
            }
            .service-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 0rem 2rem;
            }
            .service-card {
                display: flex;
                flex-direction: column;
                border: none;
                border-radius: 8px;
                overflow: hidden;
                transition: transform 0.3s, box-shadow 0.3s;
            }
            .service-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            .service-card .tag {
                background: var(--secondary-color);
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 3px;
            }
            .loading-spinner {
                width: 50px;
                height: 50px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid var(--secondary-color);
                border-radius: 50%;
                margin: 20px auto;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            @keyframes modalSlideIn {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .discount-card.loading {
                text-align: center;
                color: #666;
            }
            .discount-requirement {
                color: #666;
                font-size: 0.9rem;
                margin-top: 0.5rem;
                padding-top: 0.5rem;
                border-top: 1px dashed #eee;
            }
            .discount-value {
                background: var(--secondary-color);
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 3px;
                display: inline-block;
                margin: 0.5rem 0;
            }
            /* Discounts Page Styles */
            .discount-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 2rem;
                padding: 1rem 0;
            }
            .discount-card {
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .discount-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            }
            .discount-card h3 {
                color: var(--primary-color);
                margin-bottom: 1rem;
                font-size: 1.25rem;
            }
            .discount-description {
                color: #666;
                margin-bottom: 1rem;
                line-height: 1.4;
            }
            .discount-details {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .discount-details li {
                padding: 0.5rem 0;
                border-bottom: 1px solid #eee;
                color: var(--primary-color);
            }
            .discount-details li:last-child {
                border-bottom: none;
            }
            .discount-details li::before {
                content: "‚òÖ";
                color: var(--secondary-color);
                margin-right: 0.5rem;
            }
            .loading-spinner {
                width: 50px;
                height: 50px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid var(--secondary-color);
                border-radius: 50%;
                margin: 20px auto;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .discount-card.loading {
                text-align: center;
                color: #666;
            }
            .discount-requirement {
                color: #666;
                font-size: 0.9rem;
                margin-top: 0.5rem;
                padding-top: 0.5rem;
                border-top: 1px dashed #eee;
            }
            .discount-value {
                background: #62b966;
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 3px;
                display: inline-block;
                margin: 0.5rem 0;
            }
            .discount-service-list {
                list-style: none;
                padding: 0;
                margin: 0.5rem 0 0 0;
            }
            .discount-service-list li {
                padding: 0.25rem 0;
                color: var(--primary-color);
            }
            .discount-service-list li::before {
                content: "‚Üí";
                color: #62b966;
                margin-right: 0.5rem;
            }
            .service-header {
                padding: 1rem;
                background: var(--primary-color);
                color: white;
            }
            .service-content {
                padding: 1rem;
                flex-grow: 1;
            }
            .service-variants {
                margin-top: 1rem;
                border-top: 1px solid #eee;
            }
            .variant-selector {
                display: flex;
                align-items: center;
                padding: 0.5rem;
                cursor: pointer;
                transition: background-color 0.2s, opacity 0.2s;
            }
            .variant-selector:hover {
                background-color: #f8f9fa;
            }
            .variant-selector input[type="radio"] {
                margin-right: 1rem;
            }
            .variant-selector input[type="radio"]:disabled + span {
                opacity: 0.5;
            }
            .variant-selector:has(input[type="radio"]:disabled) {
                cursor: not-allowed;
                background-color: #f5f5f5;
            }
            .package-builder {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 2rem;
            }
            .package-summary {
                position: sticky;
                top: 2rem;
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                height: fit-content;
            }
            .package-total {
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 2px solid var(--background-color);
                font-size: 1.2rem;
                font-weight: bold;
            }
            .discount-badge {
                display: inline-block;
                padding: 0.25rem 0.5rem;
                background: #dc3545;
                color: white;
                border-radius: 3px;
                font-size: 0.8rem;
                margin-top: 0.1rem;
            }
            .package-actions {
                margin-top: 1.5rem;
                display: flex;
                gap: 1rem;
            }
            .package-action-button {
                flex: 1;
                padding: 0.8rem;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                transition: background-color 0.2s;
            }
            .package-action-button.primary {
                background-color: #646464;
                color: white;
            }
            .package-action-button.primary:hover {
                background-color: #474747;
            }
            .package-action-button.secondary {
                background-color: #e9ecef;
                color: var(--primary-color);
            }
            .package-action-button.secondary:hover {
                background-color: #dee2e6;
            }
            /* Modal Styles */
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: none;  /* Changed from flex to none */
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }
            .modal:not(.hidden) {
                display: flex;  /* Show modal when not hidden */
            }
            .modal-content {
                background: white;
                border-radius: 8px;
                width: 90%;
                max-width: 600px;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
                transform: translateY(0);
                animation: modalSlideIn 0.3s ease;
            }
            .modal-header {
                padding: 1.5rem;
                background: var(--primary-color);
                color: white;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .modal-header h3 {
                margin: 0;
            }
            .modal-close {
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background-color 0.2s;
            }
            .modal-close:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            .modal-body {
                padding: 1.5rem;
            }
            .features-section {
                margin-top: 1.5rem;
            }
            .features-section h4 {
                color: var(--primary-color);
                margin-bottom: 1rem;
            }
            .feature-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .feature-list li {
                padding: 0.5rem 0;
                display: flex;
                align-items: start;
            }
            .feature-list li::before {
                content: "‚úì";
                color: var(--secondary-color);
                margin-right: 0.75rem;
                font-weight: bold;
            }
            #modal-description {
                line-height: 1.6;
                color: #666;
            }
            .remove-service {
                background: none;
                border: none;
                color: #dc3545;
                cursor: pointer;
                padding: 0.25rem;
                margin-left: 0.5rem;
                opacity: 0.7;
                transition: opacity 0.2s;
            }
            .remove-service:hover {
                opacity: 1;
            }
            .service-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0.5rem;
                border-bottom: 1px solid #eee;
            }
            .service-item:last-child {
                border-bottom: none;
            }
            .service-item-details {
                flex: 1;
            }
            .hidden {
                display: none;
            }
            .active {
                display: block;
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: -webkit-fill-available;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
            }
            .modal.active {
                display: flex;
                justify-content: center;
                align-items: flex-start;
                padding: 20px;
            }
            .modal-content {
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 800px;
                width: 100%;
                .nav-toggle {
                    display: none;
                    background: none;
                    border: 2px solid transparent;
                    color: white;
                    font-size: 1.6rem;
                    cursor: pointer;
                    padding: 8px;
                    border-radius: 4px;
                    transition: all 0.2s ease;
                }

                .nav-toggle:hover {
                    border-color: rgba(255, 255, 255, 0.2);
                    background: rgba(255, 255, 255, 0.1);
                }

                .nav-toggle:active {
                    transform: scale(0.95);
                }

                .mobile-nav-list {
                    padding: 2rem 0 0 0;
                }

                .mobile-nav-list ul {
                    list-style: none;
                    padding: 0;
                    margin: 0;
                }

                .mobile-nav-list ul li {
                    margin: 0;
                    padding: 0;
                }

                .mobile-nav-list ul li a {
                    display: block;
                    padding: 1rem 1.5rem;
                    color: var(--primary-color);
                    text-decoration: none;
                    font-weight: 600;
                    font-size: 1.1rem;
                    transition: all 0.2s ease;
                    border-left: 4px solid transparent;
                }

                .mobile-nav-list ul li a:hover {
                    background: #f5f5f5;
                    border-left-color: var(--primary-color);
                    text-decoration: none;
                }

                .mobile-nav-list ul li a:active {
                    background: #eeeeee;
                }
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
            }
            .modal-close {
                position: absolute;
                right: 20px;
                top: 20px;
                cursor: pointer;
                font-size: 24px;
                color: #666;
            }
            .modal-close:hover {
                color: darkred;
            }

                /* Mobile nav specific modal styling */
                .mobile-nav-modal .modal-content {
                    padding: 0;
                    border-radius: 0;
                    max-width: 300px;
                    margin-left: auto;
                    margin-right: 0;
                    height: 100vh;
                    max-height: none;
                    animation: slideIn 0.3s ease-out;
                }

                .mobile-nav-modal {
                    background-color: rgba(0, 0, 0, 0.3);
                    backdrop-filter: blur(4px);
                }

                .mobile-nav-header {
                    background: var(--primary-color);
                    color: white;
                    padding: 1.5rem;
                    position: relative;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                }

                .mobile-nav-header h3 {
                    margin: 0;
                    font-size: 1.2rem;
                    color: white;
                }

                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                    }
                    to {
                        transform: translateX(0);
                    }
                }

            .modal-actions {
                margin-top: 20px;
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            }
            /* Mobile navigation toggle and FAB */
            .nav-toggle {
                display: none;
                background: none;
                border: none;
                color: white;
                font-size: 1.6rem;
                cursor: pointer;
            }

            .mobile-nav-list ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .fab {
                position: fixed;
                right: 20px;
                bottom: 20px;
                width: 56px;
                height: 56px;
                border-radius: 28px;
                background: var(--primary-color);
                color: var(--background-color);
                display: none; /* visible on mobile via media query */
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border: none;
                cursor: pointer;
                z-index: 1200;
                font-size: 20px;
            }

            @media (max-width: 768px) {
                nav ul { display: none; }
                .nav-toggle { display: block; }
                .package-builder { grid-template-columns: 1fr; }
                .fab { display: flex; }
            }
            footer {
                background-color: var(--primary-color);
                color: white;
                text-align: center;
                padding: 2rem;
                width: -webkit-fill-available;
                bottom: 0;
            }
        </style>
    </head>
    <body>
        <header>
            <div class="brand">
                <img src="https://oakshiftsoftware.github.io/source/images/logos/logo-b.png" />
                <div class="brand-text">
                    <h1>Oakshift Software</h1>
                    <p></p>
                </div>
            </div>
            <button id="nav-toggle" class="nav-toggle" aria-label="Open menu">‚ò∞</button>
            <nav>
                <ul>
                    <li><a href="#home">Home</a></li>
                    <li><a href="#services">Services</a></li>
                    <li><a href="#packages">Packages</a></li>
                    <li><a href="#discounts">Deals</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </nav>
        </header>
        <main>
            <!-- Home Page -->
            <section id="home" class="active">
                <div class="hero-banner">
                    <img src="https://oakshiftsoftware.github.io/source/images/headers/img-5.png" alt="Hero Banner" />
                    <div class="hero-overlay"></div>
                    <div class="hero-content">
                        <h1>Welcome to Oakshift Software</h1>
                        <p>Transform your business with our innovative software solutions</p>
                        <a href="#services" class="hero-button">Explore Our Services</a>
                    </div>
                </div>
                <div class="main-content">
                    <div class="card">
                        <h2>Welcome to Oakshift Software</h2>
                        <p>At Oakshift Software, we build more than code. We partner with you to design and deliver software that works for your business ‚Äî not the other way around. Whether you need a reliable internal tool, a scalable customer-facing app, or seamless integrations that simplify your workflow, we‚Äôre here to make it happen.</p>
                    </div>
                    <div class="card">
                        <h2>Why Work With Us?</h2>
                        <p>Experienced, dependable, and focused on your success.</p>
                        <ul style="margin: 1rem 0 0 0;">
                            <li><b>Tailored solutions</b> ‚Äì We don‚Äôt deliver off-the-shelf. Every project is crafted to your unique goals and challenges.</li>
                            <li><b>End-to-end ownership</b> ‚Äì From ideation and architecture through to deployment and maintenance, we‚Äôre with you every step of the way.</li>
                            <li><b>Business-first mindset</b> ‚Äì We speak both tech and business. Our work doesn‚Äôt just run ‚Äî it delivers measurable results.</li>
                            <li><b>Clear communication & strong collaboration</b> ‚Äì You‚Äôll always know what‚Äôs happening, what‚Äôs next and why.</li>
                            <li><b>Flexible engagement</b> ‚Äì Full projects, modular tasks, or ongoing support ‚Äî you decide how we work together.</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Services Page -->
            <section id="services" class="hidden">
                <div class="hero-banner">
                    <img src="https://oakshiftsoftware.github.io/source/images/headers/img-1.png" alt="Services Banner" />
                    <div class="hero-overlay"></div>
                    <div class="hero-content">
                        <h1>Our Services</h1>
                        <p>Discover our range of professional software solutions</p>
                    </div>
                </div>
                <div class="main-content" id="services-content">
                    <div class="card">
                        <h2>Our Services</h2>
                        <p>Loading services...</p>
                    </div>
                </div>
            </section>

            <!-- Packages Page -->
            <section id="packages" class="hidden">
                <div class="hero-banner">
                    <img src="https://oakshiftsoftware.github.io/source/images/headers/img-2.png" alt="Packages Banner" />
                    <div class="hero-overlay"></div>
                    <div class="hero-content">
                        <h1>Build Your Package</h1>
                        <p>Create a custom solution that fits your needs perfectly</p>
                    </div>
                </div>
                <div class="main-content" id="packages-content">
                    <div class="card">
                        <h2>Our Packages</h2>
                        <p>Loading packages...</p>
                    </div>
                </div>
            </section>

            <!-- Discounts Page -->
            <section id="discounts" class="hidden">
                <div class="hero-banner">
                    <img src="https://oakshiftsoftware.github.io/source/images/headers/img-4.png" alt="Discounts Banner" />
                    <div class="hero-overlay"></div>
                    <div class="hero-content">
                        <h1>Special Deals</h1>
                        <p>Explore our service combinations for exclusive savings</p>
                    </div>
                </div>
                <div class="main-content">
                    <div class="card">
                        <h2>Current Deals</h2>
                        <p>All deals are automatically applied when the required services are purchased together, you can try this yourself by building your package with our handy package builder.</p>
                        <div id="discount-grid" class="discount-grid">
                            <div class="discount-card loading">
                                <div class="loading-spinner"></div>
                                <p>Loading available deals...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Contact Page -->
            <section id="contact" class="hidden">
                <div class="hero-banner">
                    <img src="https://oakshiftsoftware.github.io/source/images/headers/img-3.png" alt="Contact Banner" />
                    <div class="hero-overlay"></div>
                    <div class="hero-content">
                        <h1>Contact Us</h1>
                        <p>Get in touch to discuss your project requirements</p>
                    </div>
                </div>
                <div class="main-content">
                    <div class="card">
                        <h2>Contact Us</h2>
                        <form id="contact-form">
                            <div style="margin-bottom: 1rem;">
                                <label for="name">Name:</label><br>
                                <input type="text" id="name" name="name" style="width: 100%; padding: 0.5rem;">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label for="email">Email:</label><br>
                                <input type="email" id="email" name="email" style="width: 100%; padding: 0.5rem;">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label for="message">Message:</label><br>
                                <textarea id="message" name="message" rows="4" style="width: 100%; padding: 0.5rem;"></textarea>
                            </div>
                            <button type="submit" style="background-color: var(--secondary-color); color: white; border: none; padding: 0.5rem 1rem; cursor: pointer;">Send Message</button>
                        </form>
                    </div>
                </div>
            </section>
        </main>
        <button id="package-fab" class="fab" title="View package">üì¶</button>

        <!-- Service Info Modal -->
        <div id="service-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title"></h3>
                    <button class="modal-close" onclick="closeServiceModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="modal-description"></div>
                    <div class="features-section">
                        <h4>Features:</h4>
                        <ul id="modal-features" class="feature-list"></ul>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            &copy; <script>document.write(new Date().getFullYear())</script> Oakshift Software. All rights reserved.
        </footer>
        <script>
            // Service data URLs
            const services_list_url = "https://oakshiftsoftware.github.io/source/data/services.json";
            const variants_url = "https://oakshiftsoftware.github.io/source/data/variants.json";
            const discounts_url = "https://oakshiftsoftware.github.io/source/data/discounts.json";
            
            // Store data
            let selectedServices = new Map();
            let availableDiscounts = [];
            let allServices = [];
            let allVariants = [];

            // Package cache helpers (persist package between page navigation)
            const PACKAGE_CACHE_KEY = 'oakshift_package_v1';
            let currentReferenceCode = null;
            let lastSavedContentKey = null;

            // Return a deterministic content key for the current selected services
            // (sorted list of "code-variantKey" joined by '|'). Empty string if none.
            function getPackageContentKey() {
                return Array.from(selectedServices.entries())
                    .map(([code, sel]) => `${code}-${sel.variantKey}`)
                    .sort()
                    .join('|');
            }

            function randomToken(len = 8) {
                return Math.random().toString(36).substr(2, len).toUpperCase();
            }

            function savePackageCache() {
                try {
                    const items = Array.from(selectedServices.entries()).map(([code, sel]) => ({
                        code,
                        serviceType: sel.serviceType,
                        variantKey: sel.variantKey,
                        price: sel.price,
                        name: sel.name,
                        isRecurring: sel.isRecurring
                    }));

                    // Generate content key and decide if a new reference is required
                    const contentKey = getPackageContentKey();
                    if (contentKey !== lastSavedContentKey) {
                        // New change detected (add/remove/change) -> generate fresh random ref
                        currentReferenceCode = 'PKG-' + randomToken(8);
                        lastSavedContentKey = contentKey;
                    }

                    const payload = {
                        items,
                        savedAt: Date.now(),
                        referenceCode: currentReferenceCode,
                        contentKey
                    };
                    localStorage.setItem(PACKAGE_CACHE_KEY, JSON.stringify(payload));
                } catch (e) {
                    console.error('Error saving package cache', e);
                }
            }

            function loadPackageCache() {
                try {
                    const raw = localStorage.getItem(PACKAGE_CACHE_KEY);
                    if (!raw) return false;
                    const parsed = JSON.parse(raw);
                    if (!parsed || !Array.isArray(parsed.items)) return false;

                    selectedServices = new Map(parsed.items.map(i => [i.code, {
                        serviceType: i.serviceType,
                        variantKey: i.variantKey,
                        price: i.price,
                        name: i.name,
                        isRecurring: i.isRecurring
                    }]));

                    // Restore saved content key and reference only if it matches current package
                    lastSavedContentKey = parsed.contentKey || '';
                    const currentKey = getPackageContentKey();
                    if (parsed.referenceCode && parsed.contentKey === currentKey) {
                        currentReferenceCode = parsed.referenceCode;
                    } else {
                        // Don't reuse old reference when package content differs; let save/preview generate a new one
                        currentReferenceCode = null;
                    }

                    return true;
                } catch (e) {
                    console.error('Error loading package cache', e);
                    return false;
                }
            }

            function clearPackageCache() {
                try {
                    localStorage.removeItem(PACKAGE_CACHE_KEY);
                } catch (e) {
                    console.error('Error clearing package cache', e);
                }
            }

            // Load services and variants
            async function loadServiceData() {
                try {
                    const [servicesResponse, variantsResponse] = await Promise.all([
                        fetch(services_list_url),
                        fetch(variants_url)
                    ]);
                    allServices = await servicesResponse.json();
                    allVariants = await variantsResponse.json();
                } catch (error) {
                    console.error('Error loading service data:', error);
                }
            }

            // Discounts handling
            async function loadDiscounts() {
                try {
                    if (allServices.length === 0 || allVariants.length === 0) {
                        await loadServiceData();
                    }
                    const response = await fetch(discounts_url);
                    const discounts = await response.json();
                    displayDiscounts(discounts);
                } catch (error) {
                    console.error('Error loading deals:', error);
                    displayDiscountError();
                }
            }

            function getServiceDetails(serviceId) {
                // Split the ID into base service ID and variant code
                const matches = serviceId.match(/([A-Z0-9]+)-([A-Z])/);
                if (!matches) return { name: 'Unknown Service' };

                const [, baseId, variantCode] = matches;
                const service = allServices.find(s => s.code === baseId);
                if (!service) return { name: 'Unknown Service' };

                const variantEntry = Object.entries(service.variants)
                    .find(([key]) => key === variantCode);
                
                if (!variantEntry) return { 
                    name: service.name,
                    isRecurring: false
                };

                const [, [variantName, price, isRecurring]] = variantEntry;
                return {
                    name: service.name,
                    variantName,
                    price,
                    isRecurring
                };
            }

            function displayDiscounts(discounts) {
                const grid = document.getElementById('discount-grid');
                grid.innerHTML = '';

                discounts.forEach(discount => {
                    const card = document.createElement('div');
                    card.className = 'discount-card';

                    // Get the discounted service information
                    const discountedService = getServiceDetails(discount.discountedService);
                    const discountedServiceText = discountedService.variantName ? 
                        `${discountedService.name} (${discountedService.variantName})` : 
                        discountedService.name;

                    // Get the required services information
                    const requiredServices = discount.requiredServices.map(id => {
                        const service = getServiceDetails(id);
                        return service.variantName ? 
                            `${service.name} (${service.variantName})` : 
                            service.name;
                    });

                    const savingsText = discountedService.isRecurring ? 
                        `Save ${formatPrice(discount.value)}/mo` : 
                        `Save ${formatPrice(discount.value)}`;

                    card.innerHTML = `
                        <h3>${discount.name}</h3>
                        <div class="discount-value">${savingsText}</div>
                        <p class="discount-description">
                            Get a deal on <strong>${discountedServiceText}</strong>
                            ${discountedService.isRecurring ? ' monthly fee' : ''}
                            when you combine it with these services:
                        </p>
                        <div class="discount-requirement">
                            <strong>Required Services:</strong>
                            <ul class="discount-service-list">
                                ${requiredServices.map(service => `<li>${service}</li>`).join('')}
                            </ul>
                        </div>
                    `;

                    grid.appendChild(card);
                });
            }

            function displayDiscountError() {
                const grid = document.getElementById('discount-grid');
                grid.innerHTML = `
                    <div class="discount-card">
                        <h3>Error Loading Deals</h3>
                        <p class="discount-description">
                            We're having trouble loading the current deals. Please try again later.
                        </p>
                    </div>
                `;
            }

            // Load discounts when the discounts page is shown
            document.addEventListener('DOMContentLoaded', () => {
                // Observer for discounts page
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.target.id === 'discounts' && 
                            !mutation.target.classList.contains('hidden')) {
                            loadDiscounts();
                        }
                    });
                });

                const discountsSection = document.getElementById('discounts');
                observer.observe(discountsSection, { 
                    attributes: true, 
                    attributeFilter: ['class'] 
                });

                // Event delegation for modal triggers
                document.addEventListener('click', (event) => {
                    // ignore clicks inside the modal content
                    if (event.target.closest('.modal-content')) return;

                    // Service header clicks are intentionally ignored (headers are not clickable)

                    // Variant item click
                    const variantItem = event.target.closest('.variant-item');
                    if (variantItem) {
                        const serviceData = variantItem.getAttribute('data-service-data');
                        const variantKey = variantItem.getAttribute('data-variant-key');
                        if (serviceData && variantKey) {
                            try { showServiceModal(serviceData, variantKey); } catch (e) { console.error(e); }
                        }
                        return;
                    }

                    // Variant selector click (but not the radio input itself)
                    const variantSelector = event.target.closest('.variant-selector');
                    if (variantSelector && !event.target.matches('input[type="radio"]')) {
                        const input = variantSelector.querySelector('input');
                        if (input) {
                            const serviceData = input.getAttribute('data-service-data');
                            const variantKey = input.getAttribute('data-variant-key');
                            if (serviceData && variantKey) {
                                try { showServiceModal(serviceData, variantKey); } catch (e) { console.error(e); }
                            }
                        }
                        return;
                    }
                });
            });

            // Format price as currency
            function formatPrice(price) {
                return new Intl.NumberFormat('en-GB', { 
                    style: 'currency', 
                    currency: 'GBP' 
                }).format(price);
            }

            // Modal Functions
            function showServiceModal(serviceData, variantKey = null) {
                try {
                    console.log('showServiceModal called', { serviceData, variantKey });
                    // Parse the service data if it's a string
                    const service = typeof serviceData === 'string' ? JSON.parse(serviceData) : serviceData;
                    
                    const modal = document.getElementById('service-modal');
                    const title = document.getElementById('modal-title');
                    const description = document.getElementById('modal-description');
                    const featuresList = document.getElementById('modal-features');

                    if (!modal || !title || !description || !featuresList) {
                        console.error('Modal elements missing');
                        return;
                    }

                    // Set title and base description
                    title.textContent = service.name || 'Service';
                    description.textContent = service.description || '';

                    // Clear existing features
                    featuresList.innerHTML = '';

                    // If a specific variant is selected, show its features
                    if (variantKey && service.variants && service.variants[variantKey]) {
                        const [variantName, , , variantInfo] = service.variants[variantKey];
                        title.textContent = `${service.name} - ${variantName}`;
                        if (variantInfo && variantInfo.description) {
                            description.textContent = variantInfo.description;
                            
                            if (variantInfo.features && Array.isArray(variantInfo.features)) {
                                variantInfo.features.forEach(feature => {
                                    const li = document.createElement('li');
                                    li.textContent = feature;
                                    featuresList.appendChild(li);
                                });
                            }
                        }
                    }

                    // Show modal (ensure display + class)
                    modal.style.display = 'flex';
                    // small timeout to allow styles to apply before removing hidden
                    setTimeout(() => modal.classList.remove('hidden'), 10);
                } catch (error) {
                    console.error('Error showing modal:', error);
                }
            }

            function closeServiceModal() {
                const modal = document.getElementById('service-modal');
                if (!modal) return;
                modal.classList.add('hidden');
                // hide from layout after animation duration
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }

            // Close modal when clicking outside
            document.addEventListener('click', (event) => {
                const modal = document.getElementById('service-modal');
                if (event.target === modal) {
                    closeServiceModal();
                }
            });

            // Function to create a service card element
            function createServiceCard(service, isBuilder = false) {
                const card = document.createElement('div');
                card.className = 'card service-card';
                
                const variantsList = Object.entries(service.variants)
                    .map(([key, [name, price, isRecurring]]) => {
                        const variantHtml = isBuilder ? `
                            <div class="variant-selector">
                                <input type="radio" 
                                    name="service_${service.code}" 
                                    value="${key}" 
                                    data-service="${service.code}"
                                    data-price="${price}"
                                    data-name="${name}"
                                    data-recurring="${isRecurring}"
                                    data-variant-key="${key}"
                                    data-service-data='${JSON.stringify(service)}'>
                                <span>${name}</span>
                                <span style="margin-left: auto">${formatPrice(price)}${isRecurring ? '/mo' : ''}</span>
                            </div>` : `
                            <div class="variant-item" data-variant-key="${key}" data-service-data='${JSON.stringify(service)}'>
                                <span>${name}</span>
                                <span>${formatPrice(price)}${isRecurring ? '/mo' : ''}</span>
                            </div>`;
                        return variantHtml;
                        if (isBuilder) {
                            return `
                                <div class="variant-selector">
                                    <input type="radio" 
                                        name="service_${service.code}" 
                                        value="${key}" 
                                        data-service="${service.code}"
                                        data-price="${price}"
                                        data-name="${name}"
                                        data-recurring="${isRecurring}">
                                    <span>${name}</span>
                                    <span style="margin-left: auto">${formatPrice(price)}${isRecurring ? '/mo' : ''}</span>
                                </div>`;
                        } else {
                            return `
                                <div class="variant-item">
                                    <span>${name}</span>
                                    <span>${formatPrice(price)}${isRecurring ? '/mo' : ''}</span>
                                </div>`;
                        }
                    }).join('');

                card.innerHTML = `
                    <div class="service-header">
                        <span class="tag">${service.tag}</span><br /><br />
                        <h3>${service.name}</h3>
                    </div>
                    <div class="service-content">
                        <p>${service.description}</p>
                        <div class="service-variants">
                            ${variantsList}
                        </div>
                    </div>
                `;

                // Return the card before adding event listeners if not a builder
                if (!isBuilder) {
                    return card;
                }

                // For builder cards, we need to properly wire up the event listeners
                // We need to do this after the card is added to the DOM
                setTimeout(() => {
                    const radioButtons = card.querySelectorAll('input[type="radio"]');
                    radioButtons.forEach(radio => {
                        radio.addEventListener('change', handleServiceSelection);
                    });
                }, 0);

                return card;
            }

            // Function to create the package builder
            function createPackageBuilder(services) {
                const builder = document.createElement('div');
                builder.className = 'package-builder';

                const servicesSection = document.createElement('div');
                servicesSection.className = 'services-section';

                // Group services by category
                const coreServices = services.filter(s => s.category === 'Core');
                const optionalServices = services.filter(s => s.category === 'Optional');

                // Create core services section
                servicesSection.innerHTML = '<h3 style="margin-top: 1rem; margin-bottom: 1rem;">Core Services</h3>';
                const coreGrid = document.createElement('div');
                coreGrid.className = 'service-grid';
                
                coreServices.forEach(service => {
                    const card = document.createElement('div');
                    card.className = 'card service-card';
                    
                    const variantsList = Object.entries(service.variants)
                        .map(([key, [name, price, isRecurring]]) => `
                            <label class="variant-selector">
                                <input type="radio" 
                                    name="service_${service.code}" 
                                    value="${key}" 
                                    data-service="${service.code}"
                                    data-service-type="Core"
                                    data-price="${price}"
                                    data-name="${service.name} - ${name}"
                                    data-recurring="${isRecurring}">
                                <span>${name}</span>
                                <span style="margin-left: auto">${formatPrice(price)}</span>
                            </label>
                        `).join('');

                    card.innerHTML = `
                        <div class="service-header">
                            <span class="tag">${service.tag}</span><br /><br />
                            <h3>${service.name}</h3>
                        </div>
                        <div class="service-content">
                            <p>${service.description}</p>
                            <div class="service-variants">
                                ${variantsList}
                            </div>
                        </div>
                    `;
                    coreGrid.appendChild(card);
                });
                servicesSection.appendChild(coreGrid);

                // Create optional services section
                servicesSection.innerHTML += '<h3 style="margin-top: 1rem; margin-bottom: 1rem;">Optional Services</h3>';
                const optionalGrid = document.createElement('div');
                optionalGrid.className = 'service-grid';
                
                optionalServices.forEach(service => {
                    const card = document.createElement('div');
                    card.className = 'card service-card';
                    
                    const variantsList = Object.entries(service.variants)
                        .map(([key, [name, price, isRecurring]]) => `
                            <label class="variant-selector">
                                <input type="radio" 
                                    name="service_${service.code}" 
                                    value="${key}" 
                                    data-service="${service.code}"
                                    data-service-type="Optional"
                                    data-price="${price}"
                                    data-name="${service.name} - ${name}"
                                    data-recurring="${isRecurring}"
                                    disabled>
                                <span>${name}</span>
                                <span style="margin-left: auto">${formatPrice(price)}${isRecurring ? '/mo' : ''}</span>
                            </label>
                        `).join('');

                    card.innerHTML = `
                        <div class="service-header">
                            <span class="tag">${service.tag}</span><br /><br />
                            <h3>${service.name}</h3>
                        </div>
                        <div class="service-content">
                            <p>${service.description}</p>
                            <div class="service-variants">
                                ${variantsList}
                            </div>
                        </div>
                    `;
                    optionalGrid.appendChild(card);
                });
                servicesSection.appendChild(optionalGrid);

                const summarySection = document.createElement('div');
                summarySection.className = 'package-summary';
                summarySection.innerHTML = `
                    <h3>Your Package</h3>
                    <div id="selected-services"></div>
                    <div class="package-total">
                        <div>One-time Setup Cost: <span id="package-total-amount">${formatPrice(0)}</span></div>
                        <div>Monthly Cost: <span id="package-recurring-amount">¬£0.00/mo</span></div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            Initial Payment: <span id="package-initial-total"></span>
                            <div style="font-size: 0.8em; color: #888;">(Setup Cost + First Month)</div>
                        </div>
                    </div>
                    <div class="package-actions">
                        <button id="preview-package" class="package-action-button secondary" disabled>
                            Preview Quote
                        </button>
                        <button id="export-package" class="package-action-button primary" disabled>
                            Export PDF
                        </button>
                        <button id="clear-package-cache" class="package-action-button secondary" style="background:#fff;border:1px solid #e9ecef;color:var(--primary-color);">
                            Clear Saved Package
                        </button>
                    </div>
                `;

                builder.appendChild(servicesSection);
                builder.appendChild(summarySection);

                // Add event listeners after the builder is created
                const allRadioButtons = builder.querySelectorAll('input[type="radio"]');
                allRadioButtons.forEach(radio => {
                    radio.addEventListener('change', handleServiceSelection);
                });

                // Clear saved package button
                const clearBtn = summarySection.querySelector('#clear-package-cache');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        if (confirm('Clear the saved package from cache? This will also clear your current selections.')) {
                            clearPackageCache();
                            selectedServices.clear();
                            // Uncheck any radios in this builder
                            const radios = builder.querySelectorAll('input[type="radio"]');
                            radios.forEach(r => r.checked = false);
                            // Re-enable radios
                            radios.forEach(r => r.disabled = false);
                            updatePackageSummary();
                        }
                    });
                }

                return builder;
            }

            // Handle service selection in package builder
            function handleServiceSelection(event) {
                try {
                    const radio = event.target;
                    console.log('Service selected:', radio.dataset);
                    
                    const serviceCode = radio.dataset.service;
                    const serviceType = radio.dataset.serviceType;
                    const variantKey = radio.value;
                    const price = parseFloat(radio.dataset.price);
                    const name = radio.dataset.name;
                    const isRecurring = radio.dataset.recurring === 'true';

                    if (radio.checked) {
                        console.log('Adding service to selection:', {
                            serviceCode,
                            serviceType,
                            variantKey,
                            price,
                            name,
                            isRecurring
                        });

                        selectedServices.set(serviceCode, {
                            serviceType,
                            variantKey,
                            price,
                            name,
                            isRecurring
                        });
                        // Check if we have at least one Core service
                        const hasCore = Array.from(selectedServices.values())
                            .some(service => service.serviceType === 'Core');

                        // Enable/disable Optional services based on Core service selection
                        const optionalRadios = document.querySelectorAll('input[type="radio"][data-service-type="Optional"]');
                        optionalRadios.forEach(radio => {
                            radio.disabled = !hasCore;
                        });

                        // If a Core service is selected, disable other Core service options
                        const coreRadios = document.querySelectorAll('input[type="radio"][data-service-type="Core"]');
                        if (hasCore) {
                            // find the first selected core service code
                            const selectedCoreCode = Array.from(selectedServices.entries()).find(([c, s]) => s.serviceType === 'Core')[0];
                            coreRadios.forEach(r => {
                                // keep radios for the selected core enabled so user can change variants
                                r.disabled = (r.dataset.service !== selectedCoreCode);
                            });
                        } else {
                            // no core selected - ensure all core radios enabled
                            coreRadios.forEach(r => r.disabled = false);
                        }

                        // Add warning if trying to select Optional without Core
                        if (serviceType === 'Optional' && !hasCore) {
                            alert('Please select at least one Core service before adding Optional services.');
                            radio.checked = false;
                            selectedServices.delete(serviceCode);
                            return;
                        }
                    }

                    console.log('Current selected services:', selectedServices);
                    updatePackageSummary();
                } catch (error) {
                    console.error('Error in handleServiceSelection:', error);
                }
            }

            // Remove a service from the package
            function removeService(serviceCode) {
                const service = selectedServices.get(serviceCode);
                if (service) {
                    // Uncheck the radio button
                    const radio = document.querySelector(`input[type="radio"][data-service="${serviceCode}"]:checked`);
                    if (radio) {
                        radio.checked = false;
                    }
                    
                    // Remove from selected services
                    selectedServices.delete(serviceCode);

                    // If it was a Core service, check if we need to disable Optional services
                    if (service.serviceType === 'Core') {
                        const hasCore = Array.from(selectedServices.values())
                            .some(s => s.serviceType === 'Core');
                        
                        const optionalRadios = document.querySelectorAll('input[type="radio"][data-service-type="Optional"]');
                        optionalRadios.forEach(radio => {
                            radio.disabled = !hasCore;
                        });

                        // Manage core radios: if there is still a core selected, keep only that core's radios enabled
                        const coreRadios = document.querySelectorAll('input[type="radio"][data-service-type="Core"]');
                        if (hasCore) {
                            const remainingCore = Array.from(selectedServices.entries()).find(([c, s]) => s.serviceType === 'Core');
                            const remainingCode = remainingCore ? remainingCore[0] : null;
                            coreRadios.forEach(r => {
                                r.disabled = remainingCode ? (r.dataset.service !== remainingCode) : false;
                            });
                        } else {
                            coreRadios.forEach(r => r.disabled = false);
                        }

                        // Remove any Optional services if no Core services remain
                        if (!hasCore) {
                            selectedServices.forEach((s, code) => {
                                if (s.serviceType === 'Optional') {
                                    removeService(code);
                                }
                            });
                        }
                    }

                    updatePackageSummary();
                }
            }

            // Generate PDF content
            async function generatePackagePDF() {
                // Create the PDF content
                const pdfContent = document.createElement('div');
                pdfContent.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <img src="https://oakshiftsoftware.github.io/source/images/logos/logo-b.png" style="height: 100px;">
                            <h1>Provisional Package Quote</h1>
                            <p>Generated on ${new Date().toLocaleDateString()}</p>
                        </div>
                        <div style="margin-bottom: 30px;">
                            <h2>Selected Services</h2>
                            ${Array.from(selectedServices.entries()).map(([code, service]) => `
                                <div style="margin-bottom: 15px;">
                                    <h3>${service.name}</h3>
                                    <p>Price: ${formatPrice(service.price)}${service.isRecurring ? '/mo' : ''}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-bottom: 30px;">
                            <h2>Total Cost</h2>
                            <p>One-time Cost: ${document.getElementById('package-total-amount').textContent}</p>
                            <p>Recurring Cost: ${document.getElementById('package-recurring-amount').textContent || '¬£0.00'}</p>
                        </div>
                        <div>
                            <p>This is a provisional quote and is valid for 30 days. To proceed with this package, please contact us:</p>
                            <p>Email: oakshiftsoftware@gmail.com</p>
                            <p>Reference: PKG-${Math.random().toString(36).substr(2, 9).toUpperCase()}</p>
                        </div>
                    </div>
                `;

                try {
                    const printWindow = window.open('', 'PRINT', 'height=800,width=1200');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Package Quote</title>
                            <style>
                                body {
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
                                    line-height: 1.5;
                                    color: #363636;
                                }
                                h1, h2, h3 {
                                    font-family: inherit;
                                    margin-bottom: 1rem;
                                }
                                .quote-header {
                                    text-align: center;
                                    margin-bottom: 2rem;
                                    padding-bottom: 2rem;
                                    border-bottom: 2px solid #18bc9c;
                                }
                                .quote-section {
                                    margin-bottom: 2rem;
                                    padding: 1rem;
                                    background-color: #f8f9fa;
                                    border-radius: 5px;
                                }
                                .service-item {
                                    display: flex;
                                    justify-content: space-between;
                                    padding: 0.5rem 0;
                                    border-bottom: 1px solid #dee2e6;
                                }
                                .quote-footer {
                                    margin-top: 2rem;
                                    padding-top: 2rem;
                                    border-top: 2px solid #18bc9c;
                                    font-size: 0.9rem;
                                }
                            </style>
                        </head>
                        <body>
                    `);
                    printWindow.document.write(pdfContent.innerHTML);
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                }
            }

            // Update the package summary
            function updatePackageSummary() {
                const selectedServicesDiv = document.getElementById('selected-services');
                const totalAmount = document.getElementById('package-total-amount');
                const recurringAmount = document.getElementById('package-recurring-amount');
                const initialTotal = document.getElementById('package-initial-total');
                const exportButton = document.getElementById('export-package');
                const previewButton = document.getElementById('preview-package');

                let oneTimeTotal = 0;
                let recurringTotal = 0;
                let summaryHTML = '';

                selectedServices.forEach((selection, serviceCode) => {
                    if (selection.isRecurring) {
                        recurringTotal += selection.price;
                    } else {
                        oneTimeTotal += selection.price;
                    }
                    
                    summaryHTML += `
                        <div class="service-item">
                            <div class="service-item-details">
                                <div>${selection.name}</div>
                                <div>${formatPrice(selection.price)}${selection.isRecurring ? '/mo' : ''}</div>
                            </div>
                            <button class="remove-service" onclick="removeService('${serviceCode}')">
                                ‚úï
                            </button>
                        </div>
                    `;
                });

                // Build list of selected variant codes, e.g. "AZHDNLH1-A"
                const selectedVariantCodes = Array.from(selectedServices.entries()).map(([code, sel]) => `${code}-${sel.variantKey}`);
                // Apply discounts (match now against variant codes)
                const applicableDiscounts = findApplicableDiscounts(selectedVariantCodes);
                if (applicableDiscounts.length > 0) {
                    applicableDiscounts.forEach(discount => {
                        // Handle service-specific discounts (price reversal)
                        if (discount.discountedService && selectedVariantCodes.includes(discount.discountedService)) {
                            // Find the service being discounted
                            const [serviceCode, variantKey] = discount.discountedService.split('-');
                            const service = selectedServices.get(serviceCode);
                            if (service && service.variantKey === variantKey) {
                                // Reverse the price of the specific service
                                if (service.isRecurring) {
                                    recurringTotal -= service.price;
                                } else {
                                    oneTimeTotal -= service.price;
                                }
                                summaryHTML += `
                                    <div class="service-item">
                                        <div class="service-item-details">
                                            <div>${discount.name}</div>
                                            <div class="discount-badge">-${formatPrice(service.price)}${service.isRecurring ? '/mo' : ''}</div>
                                        </div>
                                    </div>
                                `;
                            }
                        } else {
                            // Handle regular fixed/percentage discounts
                            if (discount.type === 'percentage') {
                                if (discount.target === 'total') {
                                    const discountAmount = oneTimeTotal * (discount.value / 100);
                                    oneTimeTotal -= discountAmount;
                                    summaryHTML += `
                                        <div class="service-item">
                                            <div class="service-item-details">
                                                <div>${discount.name}</div>
                                                <div class="discount-badge">-${discount.value}%</div>
                                            </div>
                                        </div>
                                    `;
                                }
                            } else if (discount.type === 'fixed') {
                                oneTimeTotal -= discount.value;
                                summaryHTML += `
                                    <div class="service-item">
                                        <div class="service-item-details">
                                            <div>${discount.name}</div>
                                            <div class="discount-badge">-${formatPrice(discount.value)}</div>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    });
                }

                selectedServicesDiv.innerHTML = summaryHTML;
                totalAmount.textContent = formatPrice(oneTimeTotal);
                recurringAmount.textContent = recurringTotal > 0 ? formatPrice(recurringTotal) + '/mo' : formatPrice(0) + '/mo';

                // Enable/disable buttons based on whether there are any services selected
                const hasServices = selectedServices.size > 0;
                exportButton.disabled = !hasServices;
                previewButton.disabled = !hasServices;
                
                // Calculate initial total (setup + first month)
                const initialPayment = oneTimeTotal + recurringTotal;
                initialTotal.textContent = formatPrice(initialPayment);
                // Persist current package selection to cache
                try { savePackageCache(); } catch (e) { console.error('Error auto-saving package', e); }
            }

            // Generate PDF content
            function generatePDFContent() {
                // Ensure a reference code exists for exported PDF
                if (!currentReferenceCode) {
                    currentReferenceCode = 'PKG-' + randomToken(8);
                    lastSavedContentKey = getPackageContentKey();
                }
                const oneTimeCost = document.getElementById('package-total-amount').textContent;
                const recurringCost = document.getElementById('package-recurring-amount').textContent;
                const initialTotal = document.getElementById('package-initial-total').textContent;

                // Group services by type
                const coreServices = Array.from(selectedServices.entries())
                    .filter(([, s]) => s.serviceType === 'Core');
                const optionalServices = Array.from(selectedServices.entries())
                    .filter(([, s]) => s.serviceType === 'Optional');

                // Build services content
                const servicesContent = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #363636; margin-bottom: 15px;">Core Services</h3>
                        ${coreServices.map(([code, service]) => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                <div>${service.name}</div>
                                <div style="font-weight: 500;">${formatPrice(service.price)}${service.isRecurring ? '/mo' : ''}</div>
                            </div>
                        `).join('')}
                        ${optionalServices.length > 0 ? `
                            <h3 style="color: #363636; margin: 20px 0 15px;">Additional Services</h3>
                            ${optionalServices.map(([code, service]) => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <div>${service.name}</div>
                                    <div style="font-weight: 500;">${formatPrice(service.price)}${service.isRecurring ? '/mo' : ''}</div>
                                </div>
                            `).join('')}
                        ` : ''}
                    </div>
                `;

                // Build discounts content
                const selectedVariantCodes = Array.from(selectedServices.entries())
                    .map(([code, sel]) => `${code}-${sel.variantKey}`);
                const applicableDiscounts = findApplicableDiscounts(selectedVariantCodes);
                const discountsContent = applicableDiscounts.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #363636; margin-bottom: 15px;">Applied Deals</h3>
                        ${applicableDiscounts.map(d => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                <div>${d.name}</div>
                                <div style="font-weight: 500; color: #dc3545;">
                                    ${d.type === 'percentage' ? `-${d.value}%` : 
                                      d.discountedService ? (() => {
                                        const [serviceCode, variantKey] = d.discountedService.split('-');
                                        const service = selectedServices.get(serviceCode);
                                        return service && service.variantKey === variantKey ? 
                                          `-${formatPrice(service.price)}${service.isRecurring ? '/mo' : ''}` : 
                                          '-Amount varies';
                                      })() : 
                                      `-${formatPrice(d.value)}`}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '';

                return `
                    <div style="padding: 20px; font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <img src="https://oakshiftsoftware.github.io/source/images/logos/logo-b.png" style="height: 100px;">
                            <h1 style="margin: 20px 0 10px;">Package Quote</h1>
                            <div style="color: #666;">Generated on ${new Date().toLocaleDateString()}</div>
                            <div style="color: #363636; font-weight: bold; margin-top: 5px;">Reference: ${currentReferenceCode}</div>
                        </div>

                        ${servicesContent}
                        ${discountsContent}

                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <div>One-time Setup Cost</div>
                                <div style="font-weight: 500;">${oneTimeCost}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <div>Monthly Cost</div>
                                <div style="font-weight: 500;">${recurringCost}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px 0; margin-top: 10px; border-top: 1px solid #eee; font-weight: bold;">
                                <div>Initial Payment Required</div>
                                <div>${initialTotal}</div>
                            </div>
                            <div style="font-size: 0.9em; color: #666; text-align: right;">
                                (Setup Cost + First Month)
                            </div>
                        </div>

                        <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee; color: #666;">
                            <p>This is a provisional quote and is valid for 30 days. To proceed with this package or discuss customizations, please contact us:</p>
                            <p style="margin-top: 15px;">
                                <strong>Email:</strong> oakshiftsoftware@gmail.com<br>
                                <strong>Phone:</strong> +44(0) 7542 104 333
                            </p>
                            <p style="margin-top: 15px;">
                                <strong>Please reference:</strong> ${currentReferenceCode}
                            </p>
                        </div>
                    </div>
                `;
            }

            // Preview PDF content
            function previewPackageQuote() {
                // Ensure we have a reference code for this session/preview
                if (!currentReferenceCode) {
                    currentReferenceCode = 'PKG-' + randomToken(8);
                    lastSavedContentKey = getPackageContentKey();
                }
                const modal = document.createElement('div');
                modal.className = 'modal';
                
                // Group services by type for more organized display
                const coreServices = Array.from(selectedServices.entries())
                    .filter(([, s]) => s.serviceType === 'Core');
                const optionalServices = Array.from(selectedServices.entries())
                    .filter(([, s]) => s.serviceType === 'Optional');
                
                // Get the costs
                const oneTimeCost = document.getElementById('package-total-amount').textContent;
                const recurringCost = document.getElementById('package-recurring-amount').textContent;
                const initialTotal = document.getElementById('package-initial-total').textContent;
                
                // Build services summary with collapsible sections
                const servicesSummary = `
                    <div class="services-summary">
                        <div class="service-group">
                            <h4>Core Services</h4>
                            ${coreServices.map(([code, service]) => `
                                <div class="service-row">
                                    <div class="service-name">${service.name}</div>
                                    <div class="service-price">${formatPrice(service.price)}${service.isRecurring ? '/mo' : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                        ${optionalServices.length > 0 ? `
                            <div class="service-group">
                                <h4>Additional Services</h4>
                                ${optionalServices.map(([code, service]) => `
                                    <div class="service-row">
                                        <div class="service-name">${service.name}</div>
                                        <div class="service-price">${formatPrice(service.price)}${service.isRecurring ? '/mo' : ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;

                // Build discounts summary if any apply
                const selectedVariantCodes = Array.from(selectedServices.entries())
                    .map(([code, sel]) => `${code}-${sel.variantKey}`);
                const applicableDiscounts = findApplicableDiscounts(selectedVariantCodes);
                const discountsSummary = applicableDiscounts.length > 0 ? `
                    <div class="discounts-summary">
                        <h4>Applied Discounts</h4>
                        ${applicableDiscounts.map(d => `
                            <div class="discount-row">
                                <div class="discount-name">${d.name}</div>
                                <div class="discount-value">
                                    ${d.type === 'percentage' ? `${d.value}%` : 
                                      d.discountedService ? (() => {
                                        const [serviceCode, variantKey] = d.discountedService.split('-');
                                        const service = selectedServices.get(serviceCode);
                                        return service && service.variantKey === variantKey ? 
                                          `-${formatPrice(service.price)}${service.isRecurring ? '/mo' : ''}` : 
                                          '-Amount varies';
                                      })() : 
                                      formatPrice(d.value)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '';

                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Package Quote Preview</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div id="preview-content" class="quote-preview">
                            <div class="quote-header">
                                <div class="quote-reference">Reference: ${currentReferenceCode}</div>
                                <div class="quote-date">Generated: ${new Date().toLocaleDateString()}</div>
                            </div>
                            
                            ${servicesSummary}
                            ${discountsSummary}
                            
                            <div class="quote-totals">
                                <div class="total-row">
                                    <div>One-time Setup</div>
                                    <div>${oneTimeCost}</div>
                                </div>
                                <div class="total-row">
                                    <div>Monthly Cost</div>
                                    <div>${recurringCost}</div>
                                </div>
                                <div class="total-row total-highlight">
                                    <div>Initial Payment</div>
                                    <div>${initialTotal}</div>
                                    <div class="total-note">(Setup + First Month)</div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="package-action-button secondary" onclick="copyToClipboard()">
                                Copy to Clipboard
                            </button>
                            <button class="package-action-button primary" onclick="exportAsPDF()">
                                Export as PDF
                            </button>
                        </div>
                    </div>
                `;
                
                // Add styles for the new compact layout
                const styleSheet = document.createElement('style');
                styleSheet.textContent = `
                    .quote-preview {
                        padding: 1.5rem;
                    }
                    .quote-header {
                        margin-bottom: 1.5rem;
                        padding-bottom: 1rem;
                        border-bottom: 1px solid #eee;
                    }
                    .quote-reference {
                        font-size: 1.1rem;
                        font-weight: bold;
                        color: var(--primary-color);
                    }
                    .quote-date {
                        font-size: 0.9rem;
                        color: #666;
                    }
                    .services-summary {
                        margin-bottom: 1.5rem;
                    }
                    .service-group {
                        margin-bottom: 1rem;
                    }
                    .service-group h4 {
                        margin-bottom: 0.5rem;
                        color: var(--primary-color);
                    }
                    .service-row, .discount-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 0.5rem;
                        border-bottom: 1px solid #f5f5f5;
                    }
                    .service-row:last-child {
                        border-bottom: none;
                    }
                    .service-name, .discount-name {
                        flex: 1;
                    }
                    .service-price, .discount-value {
                        font-weight: 500;
                        margin-left: 1rem;
                    }
                    .discounts-summary {
                        margin: 1.5rem 0;
                        padding-top: 1rem;
                        border-top: 1px solid #eee;
                    }
                    .quote-totals {
                        margin-top: 1.5rem;
                        padding-top: 1rem;
                        border-top: 1px solid #eee;
                    }
                    .total-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 0.5rem;
                        font-weight: 500;
                    }
                    .total-highlight {
                        margin-top: 0.5rem;
                        padding-top: 1rem;
                        border-top: 1px solid #eee;
                        font-size: 1.1rem;
                        font-weight: bold;
                        color: var(--primary-color);
                    }
                    .total-note {
                        display: block;
                        font-size: 0.8rem;
                        color: #666;
                        font-weight: normal;
                        margin-top: 0.25rem;
                    }
                `;
                document.head.appendChild(styleSheet);
                document.body.appendChild(modal);
                setTimeout(() => modal.classList.add('active'), 10);

                // Close modal functionality
                modal.querySelector('.modal-close').onclick = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                };

                // Close when clicking outside the modal
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        setTimeout(() => modal.remove(), 300);
                    }
                };
            }

            // Copy content to clipboard
            async function copyToClipboard() {
                const content = document.getElementById('preview-content').innerText;
                try {
                    await navigator.clipboard.writeText(content);
                    alert('Quote content copied to clipboard!');
                } catch (err) {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy content. Please try again.');
                }
            }

            // Export as PDF
            function exportAsPDF() {
                try {
                    const printWindow = window.open('', 'PRINT', 'height=800,width=1200');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Package Quote</title>
                            <style>
                                body {
                                    font-family: Arial, sans-serif;
                                    line-height: 1.6;
                                    color: #333;
                                    padding: 20px;
                                }
                                h1, h2, h3 {
                                    color: #363636;
                                }
                                @media print {
                                    body {
                                        padding: 0;
                                    }
                                }
                            </style>
                        </head>
                        <body>
                            ${generatePDFContent()}
                        </body>
                    </html>
                    `);
                    printWindow.document.close();
                    printWindow.focus();
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 250);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                }
            }

            // Find applicable discounts by comparing required variant codes (e.g. "AZHDNLH1-A")
            function findApplicableDiscounts(selectedVariantCodes) {
                return availableDiscounts.filter(discount => {
                    // Check if all required services are present
                    if (Array.isArray(discount.requiredServices) && discount.requiredServices.length > 0) {
                        const requiredMet = discount.requiredServices.every(req => selectedVariantCodes.includes(req));
                        // For service-specific discounts, also verify the discounted service exists
                        if (requiredMet && discount.discountedService) {
                            return selectedVariantCodes.includes(discount.discountedService);
                        }
                        return requiredMet;
                    }
                    return false;
                });
            }

            // Function to load services
            async function loadServices() {
                try {
                    const response = await fetch(services_list_url);
                    const services = await response.json();
                    const servicesContent = document.getElementById('services-content');
                    servicesContent.innerHTML = ''; // Clear loading message
                    
                    const serviceGrid = document.createElement('div');
                    serviceGrid.className = 'service-grid';
                    
                    services.forEach(service => {
                        serviceGrid.appendChild(createServiceCard(service));
                    });

                    servicesContent.appendChild(serviceGrid);
                } catch (error) {
                    console.error('Error loading services:', error);
                    const servicesContent = document.getElementById('services-content');
                    servicesContent.innerHTML = '<div class="card"><h2>Error</h2><p>Unable to load services. Please try again later.</p></div>';
                }
            }

            // Function to load package builder
            async function loadPackages() {
                try {
                    const [servicesResponse, discountsResponse] = await Promise.all([
                        fetch(services_list_url),
                        fetch(discounts_url).catch(() => ({ json: () => [] }))
                    ]);
                    
                    const services = await servicesResponse.json();
                    availableDiscounts = await discountsResponse.json();
                    
                    const packagesContent = document.getElementById('packages-content');
                    packagesContent.innerHTML = `
                        <h2>Build Your Package</h2>
                        <p>Select the services you'd like to include in your package. Mix and match to create your perfect solution.</p>
                    `;
                    
                    const builderElem = createPackageBuilder(services);
                    packagesContent.appendChild(builderElem);

                    // Restore package from cache (if present)
                    const restored = loadPackageCache();
                    if (restored) {
                        try {
                            // mark radios according to cached selection
                            selectedServices.forEach((sel, code) => {
                                const radio = packagesContent.querySelector(`input[type="radio"][data-service="${code}"][value="${sel.variantKey}"]`);
                                if (radio) radio.checked = true;
                            });

                            // enforce enabling/disabling based on core selection
                            const hasCore = Array.from(selectedServices.values()).some(s => s.serviceType === 'Core');
                            const optionalRadios = packagesContent.querySelectorAll('input[type="radio"][data-service-type="Optional"]');
                            optionalRadios.forEach(r => r.disabled = !hasCore);

                            const coreRadios = packagesContent.querySelectorAll('input[type="radio"][data-service-type="Core"]');
                            if (hasCore) {
                                const selectedCoreCode = Array.from(selectedServices.entries()).find(([c, s]) => s.serviceType === 'Core')[0];
                                coreRadios.forEach(r => r.disabled = (r.dataset.service !== selectedCoreCode));
                            } else {
                                coreRadios.forEach(r => r.disabled = false);
                            }

                            // Wire radio event listeners (they were added in createPackageBuilder, but ensure handlers reflect restored state)
                            const allRadioButtons = packagesContent.querySelectorAll('input[type="radio"]');
                            allRadioButtons.forEach(radio => {
                                radio.removeEventListener('change', handleServiceSelection);
                                radio.addEventListener('change', handleServiceSelection);
                            });

                            updatePackageSummary();
                        } catch (e) {
                            console.error('Error restoring package state:', e);
                        }
                    }
                } catch (error) {
                    console.error('Error loading package builder:', error);
                    const packagesContent = document.getElementById('packages-content');
                    packagesContent.innerHTML = '<div class="card"><h2>Error</h2><p>Unable to load package builder. Please try again later.</p></div>';
                }
            }

            // Handle contact form submission
            document.getElementById('contact-form').addEventListener('submit', function(e) {
                e.preventDefault();
                // Add your form submission logic here
                alert('Thank you for your message. We will get back to you soon!');
                this.reset();
            });

            // Make functions available globally
            window.copyToClipboard = copyToClipboard;
            window.exportAsPDF = exportAsPDF;

            // Open mobile nav modal (clones the nav links)
            function openMobileNav() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                const navHtml = document.querySelector('nav').innerHTML;
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="modal-close">&times;</span>
                        <div class="mobile-nav-list">${navHtml}</div>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => modal.classList.add('active'), 10);
                modal.querySelector('.modal-close').onclick = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                };
                modal.onclick = (e) => { if (e.target === modal) { modal.querySelector('.modal-close').click(); } };
                // Wire up links inside the modal to navigate SPA and close modal
                modal.querySelectorAll('a').forEach(a => {
                    a.addEventListener('click', (ev) => {
                        ev.preventDefault();
                        const target = a.getAttribute('href').substring(1);
                        navigateToPage(target);
                        modal.querySelector('.modal-close').click();
                    });
                });
            }

            // Open mobile package FAB modal showing current package summary and quick actions
            function openPackageFabModal() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                const selectedHTML = document.getElementById('selected-services')?.innerHTML || '<div class="card"><p>No services selected yet.</p></div>';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="modal-close">&times;</span>
                        <h3>Your Package (Preview)</h3><br /><br />
                        <div id="fab-package-summary">${selectedHTML}</div>
                        <div style="margin-top:12px; color:#666; font-size:0.9rem;">Initial Payment: <strong id="fab-initial">${document.getElementById('package-initial-total')?.textContent || '¬£0.00'}</strong></div>
                        <div class="modal-actions">
                            <button class="package-action-button secondary" id="fab-show-options">Show Options</button>
                            <button class="package-action-button secondary" id="fab-preview">Preview</button>
                            <button class="package-action-button primary" id="fab-export">Export</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => modal.classList.add('active'), 10);

                modal.querySelector('.modal-close').onclick = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                };
                modal.onclick = (e) => { if (e.target === modal) { modal.querySelector('.modal-close').click(); } };

                modal.querySelector('#fab-preview').addEventListener('click', () => {
                    modal.querySelector('.modal-close').click();
                    previewPackageQuote();
                });
                modal.querySelector('#fab-export').addEventListener('click', () => {
                    modal.querySelector('.modal-close').click();
                    exportAsPDF();
                });
                modal.querySelector('#fab-show-options').addEventListener('click', () => {
                    // Close modal and show the packages page options
                    modal.querySelector('.modal-close').click();
                    navigateToPage('packages');
                    // give packages time to load then scroll to the services section
                    setTimeout(() => {
                        const servicesSection = document.querySelector('#packages-content .services-section');
                        if (servicesSection) servicesSection.scrollIntoView({ behavior: 'smooth' });
                    }, 200);
                });
            }

            // Handle preview and export button clicks
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'preview-package') {
                    previewPackageQuote();
                } else if (e.target && e.target.id === 'export-package') {
                    exportAsPDF();
                }
            });

            // Function to handle page navigation
            function navigateToPage(pageId) {
                sections.forEach(section => {
                    if (section.id === pageId) {
                        section.classList.remove('hidden');
                        section.classList.add('active');
                        // Load content when navigating to services or packages
                        if (pageId === 'services') loadServices();
                        if (pageId === 'packages') loadPackages();
                    } else {
                        section.classList.remove('active');
                        section.classList.add('hidden');
                    }
                });
                // Update URL without triggering page reload
                history.pushState({page: pageId}, '', `#${pageId}`);
            }

            // Handle browser back/forward buttons
            window.addEventListener('popstate', (event) => {
                const pageId = event.state?.page || 'home';
                navigateToPage(pageId);
            });

            // Check initial URL hash on page load
            document.addEventListener('DOMContentLoaded', () => {
                const initialPage = window.location.hash.substring(1) || 'home';
                navigateToPage(initialPage);
                // Attach mobile nav toggle
                const navToggle = document.getElementById('nav-toggle');
                if (navToggle) navToggle.addEventListener('click', openMobileNav);

                // Attach package FAB handler
                const packageFab = document.getElementById('package-fab');
                if (packageFab) packageFab.addEventListener('click', (e) => {
                    // ensure we're on packages page (switch if necessary)
                    const current = document.querySelector('main section.active')?.id;
                    if (current !== 'packages') {
                        navigateToPage('packages');
                        // wait a short time to ensure packages loaded
                        setTimeout(() => openPackageFabModal(), 300);
                    } else {
                        openPackageFabModal();
                    }
                });
            });

            // Establish page routing system for single-page application
            const sections = document.querySelectorAll('main section');
            const navLinks = document.querySelectorAll('nav ul li a');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    navigateToPage(targetId);
                });
            });
        </script>
    </body>
</html>
